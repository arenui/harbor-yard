---
- name: Map architecture to Docker repo arch
  ansible.builtin.set_fact:
    docker_repo_arch: >-
      {% if ansible_architecture in ['x86_64', 'amd64'] %}amd64
      {% elif ansible_architecture in ['aarch64', 'arm64'] %}arm64
      {% elif ansible_architecture in ['armv7l'] %}armhf
      {% else %}{{ ansible_architecture }}
      {% endif %}

- name: Install Docker repo prerequisites
  ansible.builtin.apt:
    name:
      - ca-certificates
      - curl
      - gnupg
    state: present
    update_cache: true
  when: ansible_os_family == "Debian"

- name: Ensure keyrings dir exists
  ansible.builtin.file:
    path: /etc/apt/keyrings
    state: directory
    owner: root
    group: root
    mode: "0755"
  when: ansible_os_family == "Debian"

- name: Install Docker GPG key (keyring)
  ansible.builtin.shell: |
    set -euo pipefail
    curl -fsSL "https://download.docker.com/linux/{{ ansible_distribution | lower }}/gpg" \
      | gpg --dearmor -o /etc/apt/keyrings/docker.gpg
    chmod a+r /etc/apt/keyrings/docker.gpg
  args:
    creates: /etc/apt/keyrings/docker.gpg
    executable: /bin/bash
  when:
    - ansible_os_family == "Debian"
    - ansible_distribution in ["Ubuntu", "Debian"]

- name: Remove any existing Docker repository files
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop:
    - /etc/apt/sources.list.d/docker.list
    - /etc/apt/sources.list.d/archive_uri-https_download_docker_com_linux_ubuntu-noble.list
  when:
    - ansible_os_family == "Debian"
    - ansible_distribution in ["Ubuntu", "Debian"]

- name: Add Docker apt repo
  ansible.builtin.apt_repository:
    repo: >-
      deb [arch={{ docker_repo_arch }} signed-by=/etc/apt/keyrings/docker.gpg]
      https://download.docker.com/linux/{{ ansible_distribution | lower }}
      {{ ansible_distribution_release }} stable
    state: present
    filename: docker
    update_cache: true
  when:
    - ansible_os_family == "Debian"
    - ansible_distribution in ["Ubuntu", "Debian"]

- name: Install Docker Engine + plugins
  ansible.builtin.apt:
    name: "{{ docker_packages }}"
    state: present
  when: ansible_os_family == "Debian"

- name: Ensure docker service enabled and running
  ansible.builtin.service:
    name: docker
    enabled: true
    state: started

- name: Ensure docker group exists
  ansible.builtin.group:
    name: docker
    state: present

- name: Add users to docker group
  ansible.builtin.user:
    name: "{{ item }}"
    groups: ["docker"]
    append: true
  loop: "{{ docker_users }}"

- name: Compute daemon config (defaults + overrides)
  ansible.builtin.set_fact:
    docker_daemon_config: "{{ docker_daemon_defaults | combine(docker_daemon_overrides, recursive=True) }}"

- name: Write /etc/docker/daemon.json
  ansible.builtin.copy:
    dest: /etc/docker/daemon.json
    content: "{{ docker_daemon_config | to_nice_json }}"
    owner: root
    group: root
    mode: "0644"
  notify: Restart docker
