---
- name: Ensure secrets destination directory exists
  ansible.builtin.file:
    path: "{{ secrets_dest_dir }}"
    state: directory
    owner: root
    group: root
    mode: "0750"

- name: Check if age key file exists
  ansible.builtin.stat:
    path: "{{ secrets_age_key_file }}"
  register: _age_key_stat

- name: Warn if age key missing
  ansible.builtin.debug:
    msg: >
      WARNING: Age key not found at {{ secrets_age_key_file }}.
      SOPS decryption will fail. Deploy your age private key to this location first.
  when: not _age_key_stat.stat.exists

- name: Find SOPS-encrypted env files
  ansible.builtin.find:
    paths: "{{ secrets_src_dir }}"
    patterns: "*.env.enc"
    size: 1 # Skip empty files
  register: _encrypted_files
  delegate_to: localhost
  become: false

- name: Decrypt and deploy env files
  ansible.builtin.copy:
    content: "{{ lookup('community.sops.sops', item.path) }}"
    dest: "{{ secrets_dest_dir }}/{{ item.path | basename | regex_replace('\\.enc$', '') }}"
    owner: root
    group: root
    mode: "0640"
  loop: "{{ _encrypted_files.files }}"
  when:
    - _age_key_stat.stat.exists
    - _encrypted_files.files | length > 0
  no_log: true # Don't log decrypted secrets

- name: Find SOPS-encrypted config files
  ansible.builtin.find:
    paths: "{{ configs_src_dir }}"
    patterns: "*-*.enc"
    recurse: true
    size: 1 # Skip empty files
  register: _encrypted_configs
  delegate_to: localhost
  become: false

- name: Ensure config destination directories exist
  ansible.builtin.file:
    path: "{{ stacks_data_dir }}/{{ item.path | basename | regex_replace('^([^-]+)-(.+)\\.enc$', '\\1') }}"
    state: directory
    owner: root
    group: root
    mode: "0755"
  loop: "{{ _encrypted_configs.files }}"
  when:
    - _age_key_stat.stat.exists
    - _encrypted_configs.files | length > 0

- name: Remove directories created by Docker at config file paths
  ansible.builtin.file:
    path: "{{ stacks_data_dir }}/{{ item.path | basename | regex_replace('^([^-]+)-(.+)\\.enc$', '\\1/\\2') }}"
    state: absent
  loop: "{{ _encrypted_configs.files }}"
  when:
    - _age_key_stat.stat.exists
    - _encrypted_configs.files | length > 0

- name: Decrypt and deploy config files
  ansible.builtin.copy:
    content: "{{ lookup('community.sops.sops', item.path) }}"
    dest: "{{ stacks_data_dir }}/{{ item.path | basename | regex_replace('^([^-]+)-(.+)\\.enc$', '\\1/\\2') }}"
    owner: root
    group: root
    mode: "0644"
  loop: "{{ _encrypted_configs.files }}"
  when:
    - _age_key_stat.stat.exists
    - _encrypted_configs.files | length > 0
  no_log: true # Don't log decrypted configs
